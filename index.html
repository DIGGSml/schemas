<!DOCTYPE html>
<html>
    <head>
        <title>Title</title>
    </head>
    <body>
        <script>
            // Script to create listing of repository contents for Github pages - for sites with a branch being the root folder
            //Set variables to determine directory location ans repository name
                var path = document.location.pathname.substring(0,document.location.pathname.lastIndexOf("/"));
                var repo = path.substring(1, path.length);
                if(repo.indexOf("/") > 0) repo = repo.substring(0,repo.indexOf("/"));
                var dir = path.substring(repo.length+1,path.length);
                  console.log("Path =" + path);
                  console.log("Repository = " + repo);
                  console.log("Directory = " + dir);

            //Write out header lines
                var txt = "<h1>Index of " + path + "</h1>";
                txt += '<table>';
                txt += '<tr><th valign="top"><img src="https://apache.org/icons/blank.gif" alt="[ ]"></th><th><a href="?C=N;O=D">Name</a></th><th><a href="?C=M;O=A">Last Modified</a></th><th><a href="?C=S;O=A">Size</a></th></tr>';
                txt += '<tr><th colspan="4"><hr></th></tr>';
                txt += '<tr><td valign="top"><img src="https://apache.org/icons/back.gif" alt="[PARENTDIR]"></td><td><a href="../">Parent Directory</a></td><td align="right">  - </td><</tr>';

                // Call Github API to get repository contents
                (async () => {
                    var api = "https://api.github.com/repos/diggsml/" + repo + "/contents";
                    const response = await fetch(api);
                    const data = await response.json();
                    var dString = "";
                    //Loop to parse JSON response; do not list resouce files and folders
                    for (let rec of data) {
                        if(rec.name == "scripts") continue;
                        if(rec.name == "icons") continue;
                        if(rec.name == "stylesheets") continue;
                        if(rec.name == "index.html") continue;
                        if(rec.name == "img") continue;
                        if(rec.name == ".gitignore") continue;
                        if(rec.name == "README.md") continue;
                        if(rec.name == "LICENSE"); continue;

                        //Find file type and sassign icon for directory display
                        if(rec.type == "file") {
                            var suffix = rec.name.substring(rec.name.lastIndexOf(".")+1,rec.name.length);
                            if(suffix == "xml"){
                                var image ='<img src="https://apache.org/icons/xml.png" alt="[XML]">';
                            }else if(suffix == "zip" || suffix == "gz" || suffix == "Z" || suffix == "bz2"){
                                image ='<img src="https://apache.org/icons/compressed.gif" alt="[ZIP]">';
                            }else image ='<img src="https://apache.org/icons/generic.gif" alt="[UNK]">';
                        }
                        if(rec.type == "dir") image ='<img src="https://apache.org/icons/folder.gif" alt="[DIR]">';
                        var size = rec.size;
                        if(size == 0){
                            size = '';
                        } else if(size < 1000) {
                            size = size + " bytes";
                        } else if(size >= 1000 && size < 1000000){
                            size = Math.round(size/1000 * 10) / 1
                            size = size + ' KB';
                        } else if(size >= 1000000) {
                            size = Math.round(size/1000000 * 10) / 10;
                            size = size + ' MB';
                        }


                        //Build request string for determining last commit date for item
                        var commitapi = "https://api.github.com/repos/diggsml/" + repo + "/commits?path=" + dir + "/" + rec.name + "&page=1&per_page=1"; 

                         //Call function to return last commit date
                         const resp = await fetch(commitapi);
                        const dat = await resp.json();
                        for (let dt of dat) {
                            var d = new Date(dt.commit.author.date);
                            dString = d.getFullYear() +'-'+('0' + d.getMonth()+1).slice(-2) + '-'+('0' + d.getDate()).slice(-2)+' '+('0' + d.getHours()).slice(-2)+':'+('0' + d.getMinutes()).slice(-2)+':'+('0' + d.getSeconds()).slice(-2);
                        }
                        //Write out row for item
                        txt += '<tr><td valign="top">'+image+'</td><td><a href="'+rec.name+'">'+rec.name+'</a></td><td>'+dString+'</td><td>'+size+'</td</tr>';
                    }
                    txt += '</table>';

                     //Set text on web pabe
                    document.getElementById('list').innerHTML = txt;
                })()
        </script>
        <div id="list"></div>
        <meta charset="utf-8">

        <div style="font-size:0.8em; font-family:arial; text-align: center;">
        <div style="border: 0px #333366 double; text-align: center; margin: 1em auto; padding: 2px; width: 99%;">
        <p>
        <a href="http://diggsml.org/def/">diggsml.org/def</a> is the official resource repository
        for the <a href="http://diggsml.org">DIGGS interchange standard</a>, a Special Project of the ASCE Geo-Institute (G-I).
        <br />
        </p>
        </div>
        </div>
    </body>
 </html>
